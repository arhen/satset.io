# satset.io - AGENTS.md

> Instructions for AI coding agents working on this project.

## Tech Stack

| Category | Technology |
|----------|------------|
| **Runtime** | Bun (dev) + Cloudflare Workers (prod) |
| **Backend** | Elysia (TypeBox validation) |
| **Frontend** | React 19 |
| **Routing** | TanStack Router (file-based) |
| **Data Fetching** | TanStack Query |
| **Forms** | React Hook Form + Zod |
| **Database** | Cloudflare D1 (SQLite) |
| **Cache** | Cloudflare KV |
| **Styling** | Tailwind CSS v4 |
| **Animations** | Framer Motion |
| **QR Code** | qrcode (canvas-based) |

## Commands

```bash
bun install          # Install dependencies
bun dev              # Run frontend (3000) + backend (8787)
bun run build        # Build for production
bun run deploy       # Build + deploy to Cloudflare
bun run db:init      # Initialize local D1 database
bunx tsr generate    # Generate TanStack Router route tree
```

## Project Structure

```
satset.io/
├── public/                     # Static assets
│   ├── favicon.svg
│   ├── index.html              # HTML entry (refs src/client/main.tsx)
│   └── og-image.png
├── src/
│   ├── index.ts                # Dev server (Bun + proxy)
│   ├── client/                 # React frontend
│   │   ├── main.tsx            # React entry point
│   │   ├── routeTree.gen.ts    # Auto-generated by TanStack Router CLI
│   │   ├── routes/             # File-based routing
│   │   │   ├── __root.tsx      # Root layout
│   │   │   ├── index.tsx       # Home page (/)
│   │   │   ├── privacy.tsx     # Privacy page (/privacy)
│   │   │   └── $alias.tsx      # Redirect page (/:alias)
│   │   ├── components/         # Shared UI components
│   │   ├── hooks/              # Custom React hooks
│   │   ├── lib/                # Client utilities
│   │   │   ├── sync.ts         # Offline-first sync logic
│   │   │   ├── api.ts          # API client
│   │   │   └── validation.ts   # Zod schemas for forms
│   │   └── global.css          # Tailwind styles
│   └── api/                    # Cloudflare Worker backend
│       ├── worker.ts           # Elysia API routes
│       ├── schemas.ts          # TypeBox validation schemas
│       ├── types.ts            # TypeScript types
│       ├── lib/                # Backend utilities
│       │   ├── security.ts     # URL validation, SSRF protection
│       │   ├── rateLimit.ts    # KV-based rate limiting
│       │   ├── cache.ts        # KV cache helpers
│       │   └── qrcode.ts       # QR generation
│       └── db/
│           └── schema.sql      # D1 database schema
├── scripts/
│   └── build.ts                # Production build script
├── tsr.config.json             # TanStack Router config
├── wrangler.toml.example       # Cloudflare config template
└── package.json
```

## Architecture

### Offline-First Flow

```
1. User pastes URL
       ↓
2. Generate alias + QR locally (instant, no network)
       ↓
3. User commits (copy link / download QR)
       ↓
4. Add to localStorage sync queue
       ↓
   ┌───┴───┐
   ↓       ↓
ONLINE   OFFLINE
   ↓       ↓
 Sync    Queue & wait
   ↓       ↓
   └───┬───┘
       ↓
5. Retry with exponential backoff (max 5 attempts)
       ↓
6. URL stored in D1, cached in KV
```

**Key files:**
- `src/client/lib/sync.ts` - Queue management, retry logic, online/offline listeners
- `src/client/hooks/useUrlShortener.ts` - URL generation, commit flow
- `src/client/hooks/useSyncStatus.ts` - Sync state subscription

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/urls` | Create short URL |
| GET | `/api/urls/check/:alias` | Check alias availability |
| GET | `/api/redirect/:alias` | Get redirect data (JSON) |
| GET | `/:alias` | Serve SPA (frontend handles redirect) |

### Database Schema

```sql
-- urls table
alias        TEXT PRIMARY KEY
original_url TEXT NOT NULL
click_count  INTEGER DEFAULT 0
created_at   INTEGER NOT NULL
expires_at   INTEGER NOT NULL

-- Rate limits: stored in KV with TTL (no table)
```

## Routing (TanStack Router)

**File-based routing** - each file in `src/client/routes/` becomes a route.

```
routes/
├── __root.tsx    →  Root layout (wraps all routes)
├── index.tsx     →  /
├── privacy.tsx   →  /privacy
└── $alias.tsx    →  /:alias (dynamic segment)
```

**Important:**
- Run `bunx tsr generate` after adding/removing route files
- Route components are defined **inline** in each route file (not imported)
- `routeTree.gen.ts` is auto-generated, don't edit manually

## Security

- **Rate Limiting**: 10/min, 100/day per IP (KV-based)
- **URL Validation**: HTTPS only, max 2048 chars
- **SSRF Protection**: Blocks localhost, private IPs, link-local addresses
- **Defense in Depth**: URLs re-validated on redirect
- **Security Headers**: CSP, X-Frame-Options, X-Content-Type-Options
- **Auto-Expiry**: URLs deleted after 14 days

## Code Conventions

### Frontend
- Page components **inline** in route files (no separate page component files)
- Shared components in `src/client/components/`
- Custom hooks in `src/client/hooks/`
- Use TanStack Query for server state
- Use React Hook Form + Zod for forms

### Backend
- Elysia with TypeBox (`t`) for request/response validation
- Schemas defined in `src/api/schemas.ts`
- Security checks in `src/api/lib/security.ts`

### Styling
- Tailwind CSS v4 (CSS-first config)
- Use `clsx` for conditional classes
- Dark mode via `useTheme()` hook

## Environment

| Resource | Value |
|----------|-------|
| Production URL | `https://satset.io` |
| D1 Database | `url-shortener-db` |
| KV Namespace | `CACHE` |
| Cron | Daily cleanup at 00:00 UTC |
